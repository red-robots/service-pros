/*!
 * widgets
 * @version: 9.0.017.30
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([21],{"./webapp/plugins/cx-webchat-service/transports/pure-connect-v4-bots-transport.js":function(t,e,n){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){var n={};for(var o in t)e.indexOf(o)>=0||Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n}var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},p=n("./node_modules/jquery/dist/jquery.js"),u=o(p),d=n("./webapp/plugins/cx-common/cx-common.js"),l=o(d),g={init:function(t){g.transport=t},updateSessionCookies:function(){var t=g.transport,e=t.oSessionData;l.default.setCookie(t.sCookie_ChatId,e.chatId),l.default.setCookie(t.sCookie_Session,e.sessionId),l.default.setCookie(t.sCookie_ParticipantId,e.participantId)},removeCookies:function(){var t=g.transport;l.default.deleteCookie(t.sCookie_ChatId),l.default.deleteCookie(t.sCookie_Session),l.default.deleteCookie(t.sCookie_ParticipantId),l.default.deleteCookie(t.sCookie_Open)},getSessionFromCookie:function(){var t=g.transport;t.oSessionData.chatId=l.default.getCookie(t.sCookie_ChatId),t.oSessionData.sessionId=l.default.getCookie(t.sCookie_Session),t.oSessionData.participantId=l.default.getCookie(t.sCookie_ParticipantId)},getHeaders:function(){var t=g.transport;return c({},t.oHeaders)},transformMessage:function(t){var e=g.transport,n=t.participantId,o=t.sequenceNumber;if(n){var s=e.oParticipants[n];if(s){var a=s.name,r=s.type;t.from={name:a||"",type:r||"Client",id:n}}}return o&&(t.index=o),t},parseMessageForEvents:function(t,e){var n=g.transport,o=n.messageTypeMapping[t.__type],s=t.participantId,a={};if("ChatStarted"===o)return n.oSessionData.participantId=s,n.oSessionData.chatId=t.chatId,g.updateSessionCookies(),void n.onChatStarted({data:n.oSessionData});if("ParticipantStateChanged"===o){var r=t.state,i=t.participantType;if("WebUser"===i&&(i="Client"),2===r)switch(t.type="participantjoined",n.oParticipants[s]={name:t.displayName,type:i},"Agent"===i&&(n.oAgents[s]={name:t.displayName,connected:!0,supervisor:!1,connectedTime:t.timestamp,disconnectedTime:!1}),t=g.transformMessage(t),a={message:t,agents:n.oAgents},i){case"Agent":n.onAgentConnected(a);break;case"Bot":n.onBotConnected(a);break;case"Client":n.onClientConnected(a)}else if(4===r)switch(t.type="participantleft",n.oAgents[s]&&(n.oAgents[s].connected=!1,n.oAgents[s].disconnectedTime=t.timestamp),t=g.transformMessage(t),a={message:t,agents:n.oAgents},i){case"Agent":n.onAgentDisconnected(a),n.onAgentTypingStopped(a);break;case"Bot":n.onBotDisconnected(a);break;case"Client":n.onClientDisconnected(a),n.endChat()}}var c=n.oParticipants[s].type;t=g.transformMessage(t),"Message"!==o||"Agent"!==c&&"Supervisor"!==c||(t.type="message",n.onAgentTypingStopped(t)),"TypingIndicator"===o&&(t.value?(t.type="typingstarted",n.onAgentTypingStarted(t)):(t.type="typingstopped",n.onAgentTypingStopped(t)))},formatMessage:function(t,e){var n=g.transport,o=new Date(t.timestamp).getTime(),s={};return g.parseMessageForEvents(t,e),s.type=t.type?t.type:n.messageTypeMapping[t.__type],"message"===s.type.toLowerCase()&&(s.text=t.value),s.restoring=n.bRestoring,s.index=t.sequenceNumber,s.timestamp=o,s.from={participantId:t.participantId,name:n.oParticipants[t.participantId]&&n.oParticipants[t.participantId].name,type:n.oParticipants[t.participantId]&&n.oParticipants[t.participantId].type},s},parseTranscript:function(t,e){var n=g.transport,o=[],s=[];s.push(t),o.push(g.formatMessage(t,e)),o.sort(function(t,e){return t.index-e.index}),o.length>0&&n.onMessageReceived({data:{originalMessages:s,messages:o,restoring:!!n.bRestoring,oldMessages:!1}})},processSocketFrame:function(t){if(t){var e=t,n=g.transport;!0===e.chatEnded&&!0===n.bSessionActive&&g.terminateChatSession(),g.parseTranscript(e)}},restore:function(t){var e=u.default.Deferred(),n=g.transport;return n.bSessionActive=!0,n.onRestore(),t?(n.bRestoring=!1,e.resolve()):g.getAllMessages().then(function(t){t.length&&g.parseTranscript(t,{type:"restore"}),n.bRestoring=!1,n.startPoll(),e.resolve()}),e.promise()},getFormData:function(t){if(t){var e=t.firstname,n=t.lastname,o=a(t,["firstname","lastname"]),s=c({},g.transport.oUserData);return"object"===i(t.userData)&&(s=c({},s,t.userData)),c({firstName:e,lastName:n},s,o)}return{}},terminateChatSession:function(){var t=g.transport;t.stopPoll(),g.removeCookies(),t.bSessionActive=!1,t.oAgents={},t.oSessionData={},t.oParticipants={},t.oAuthHeader={}},sendRequest:function(t){var e=u.default.Deferred(),n=g.transport,o=t.endpoint,s=a(t,["endpoint"]),r=n.sHost||g.getHost();if(!r)return n.oLastError?e.reject(n.oLastError):e.reject("No more hosts to try.");var i=g.createUrl(r,o);return l.default.request(c({url:i},n.oCommonRequestOptions,s,{headers:g.getHeaders(),success:function(t){n.sHost=r,n.aAttemptedHosts.length=0,t&&t.pollWaitSuggestion&&g.updatePollingInterval(parseInt(t.pollWaitSuggestion)),n.bSwitchoverDetected&&(n.restore(),n.bSwitchoverDetected=!1),e.resolve(t)},error:function(o){n.oLastError=o,503===o.status?(n.sHost&&(n.bSwitchoverDetected=!0,n.bSessionActive=!1),n.sHost="",n.aAttemptedHosts.push(r),o.responseJSON&&o.responseJSON.alternateHostList&&(n.aAdditionalHosts=o.responseJSON.alternateHostList.slice()),g.retry(t,e)):t.retryOnFailure?(n.aAttemptedHosts.push(r),g.retry(t,e)):e.reject(o)}})),e.promise()},retry:function(t,e){g.sendRequest(t).then(function(t){e.resolve(t)},function(t){e.reject(t)})},getHost:function(){var t=g.transport,e=[];return t.aAdditionalHosts.forEach(function(n){t.aAttemptedHosts.includes(n.toLowerCase())||e.push(n.toLowerCase())}),t.aHosts.forEach(function(n){t.aAttemptedHosts.includes(n.toLowerCase())||e.includes(n.toLowerCase())||e.push(n.toLowerCase())}),e.length?e[0]:""},handleError:function(t){var e=g.transport,n=t&&(t.responseJSON||t.responseText&&JSON.parse(t.responseText)||{});if(n)var o=n.status;e.onError({code:o&&e.errorPrefix+o||"",response:t})},disconnected:function(){var t=g.transport;t.bDisconnected=!0,t.onDisconnected()},reconnected:function(){var t=g.transport;t.bDisconnected=!1,t.onReconnected()},createUrl:function(t,e){var n=g.transport,o=e.replace("{server}",t);return("dev"===n.environmentType?"https://pureconnect-chat.us-east-1.inindca.com/api/v1/start/":"test"===n.environmentType?"https://pureconnect-chat.us-east-1.inintca.com/api/v1/start/":"https://pureconnect-chat.us-east-1.mypurecloud.com/api/v1/start/")+o},getDisplayName:function(t){var e="Customer";return t.nickname?e=t.nickname:t.firstName&&t.lastName&&"string"==typeof t.firstName&&"string"==typeof t.lastName?e=t.firstName+" "+t.lastName:t.firstName&&"string"==typeof t.firstName&&(e=t.firstName),e},clientStoppedTyping:function(){g.transport.sendTyping({isTyping:!1})},getAllMessages:function(){var t=u.default.Deferred(),e=g.transport,n=e.oSessionData.sessionId,o={type:"GET",endpoint:"{server}/"+n};return g.sendRequest(o).then(function(n){var o=n.messages.filter(function(t){return"TypingIndicator"!==e.messageTypeMapping[t.__type]});t.resolve(o)},function(e){t.reject(e),g.handleError(e)}),t.promise()},getWebsocketUrl:function(){var t=g.transport,e=t.environmentType,n=t.oSessionData;return"dev"===e?"wss://6napswoand.execute-api.us-east-1.amazonaws.com/v1?channel="+n.sessionId:"test"===e?"wss://o3u8hhtgb9.execute-api.us-east-1.amazonaws.com/v1?channel="+n.sessionId:"wss://lr116vh029.execute-api.us-east-1.amazonaws.com/v1?channel="+n.sessionId},subscribeSocketEvents:function(t){var e=g.transport;e.mySocket.onmessage=function(t){var e=JSON.parse(t.data);g.processSocketFrame(e)},e.mySocket.addEventListener("close",function(t){clearTimeout(e.WebSocketTimeout),e.bSocketConnectionLost=!0,e.mySocket=null,e.bSessionActive&&(e.bOpeningSocket=!0,g.startWebSocketConnection())}),e.mySocket.addEventListener("error",function(n){e.bSocketConnectionLost||g.handleError(n),e.bSessionActive||(t.reject("websocket failed to open"),e.bRestoring&&e.onRestoreFailed()),e.bOpeningSocket=!1})},startWebSocketConnection:function(){var t=g.transport,e=u.default.Deferred();return t.mySocket=new WebSocket(g.getWebsocketUrl()),t.mySocket.addEventListener("open",function(n){t.bSessionActive=!0,t.bSocketConnectionLost&&(t.bSocketConnectionLost=!1,t.onReconnected()),e.resolve()}),g.subscribeSocketEvents(e),e.promise()}},f=function(){function t(e){s(this,t),this.oConfig=e,this.bDisconnected=!1;var n="."+e.transport.type;if(this.transportType="",this.environmentType=e.transport.environmentType||"production",this.oUserData=e.oUserData,this.errorPrefix=e.transport.type+"-",this.oParticipants={},this.oAgents={},this.chatBotData="",this.chatbotCustomData={},this.aHosts=[],this.aAttemptedHosts=[],this.aAdditionalHosts=[],this.sHost,this.bUseHttps=!0,this.sReverseProxyUrl="",this.bSwitchoverDetected=!1,this.oLastError={},this.oHeaders={},this.mySocket={},this.oAuthHeader={},this.bUseCaaS=!1,this.sCaasUrl="",this.iClientTypingTimeout=3e3,this.bLastTypingStateSent=!1,this.bSessionActive=!1,this.oSessionData={sessionId:"",participantId:"",chatId:""},this.sCookie_Session=e.sCookie_Prefix+n+".session",this.sCookie_ChatId=e.sCookie_Prefix+n+".chatId",this.sCookie_ParticipantId=e.sCookie_Prefix+n+".participantId",this.sCookie_Open=e.sCookie_Prefix+n+".open",this.bRestoring=!1,this.oCommonRequestOptions={timeout:e.iAjaxTimeout||3e3,crossDomain:!0,dataType:"json",contentType:"application/json"},this.interactionOptions={routingTarget:{targetType:"",targetName:""},memberInfo:{displayName:"Customer",customFields:{}}},this.oMapping={"interactionData.routing.targetType":{target:"routingTarget.targetType",type:"string",default:"Workgroup"},"interactionData.routing.targetName":{target:"routingTarget.targetName",type:"string"},"interactionData.routing.routingContexts":{target:"routingContexts"},"interactionData.notes":{target:"notes",type:"string"},"interactionData.botName":{target:"botName",type:"string"},botCustomData:{target:"botDataCustomInfo"},"interactionData.journey.customerId":{target:"additionalAttrs.AltocloudCustomerId",type:"string"},"interactionData.journey.customerIdType":{target:"additionalAttrs.AltocloudCustomerIdType",type:"string"},"interactionData.journey.actionMapId":{target:"additionalAttrs.AltocloudActionMapId",type:"string"},"userData._actVisitId":{target:"additionalAttrs.AltocloudVisitId",type:"string"},"userData.targetQueue":{target:"routingTarget.AltocloudTargetQueue",type:"string"}},this.messageTypeMapping={"urn:inin.com:webChat:chatTextMessage":"Message","urn:inin.com:webChat:chatFileMessage":"File","urn:inin.com:webChat:chatParticipantStateChangedMessage":"ParticipantStateChanged","urn:inin.com:webChat:chatTypingIndicatorMessage":"TypingIndicator","urn:inin.com:webChat:startChatMessage":"ChatStarted"},this.bSocketConnectionLost=!1,this.socketReconnectInterval=2e3,this.socketHeartbeatTrackerInterval=14e3,this.socketConnectionCloseTime=2,"object"===i(e.transport)){var o=e.transport;"string"==typeof o.type&&(this.transportType=o.type),Array.isArray(o.hosts)&&(this.aHosts=o.hosts),"boolean"==typeof o.useHttps&&(this.bUseHttps=o.useHttps),"string"==typeof o.reverseProxyUrl&&(this.sReverseProxyUrl=o.reverseProxyUrl),"object"===i(o.headers)&&(this.oHeaders=o.headers),"string"==typeof o.chatBotData&&(this.chatBotData=o.chatBotData),"string"==typeof o.botCustomData&&(this.chatbotCustomData=o.botCustomData),"boolean"==typeof o.useCaaS&&(this.bUseCaaS=o.useCaaS),"string"==typeof o.caasUrl&&(this.sCaasUrl=o.caasUrl),this.interactionOptions=l.default.mapProperties(this.oMapping,o,this.interactionOptions),this.interactionOptions.additionalAttrs=u.default.extend({},this.interactionOptions.additionalAttrs||{},o.additionalAttrs||{},!0)}this.onChatStarted=this.onChatStarted.bind(this),this.onMessageReceived=this.onMessageReceived.bind(this),this.onRestore=this.onRestore.bind(this),this.onError=this.onError.bind(this),g.init(this)}return r(t,[{key:"onCapabilitiesChanged",value:function(t){}},{key:"onChatEnded",value:function(t){}},{key:"onChatStarted",value:function(t,e){}},{key:"onError",value:function(t){}},{key:"onMessageReceived",value:function(t){}},{key:"onRestore",value:function(t){}},{key:"onRestoreFailed",value:function(t){}},{key:"onTypingStarted",value:function(){}},{key:"onTypingStopped",value:function(){}},{key:"startChat",value:function(t){var e=u.default.Deferred(),n=this,o="",s=g.getFormData(t.form);n.interactionOptions&&Object.keys(n.interactionOptions).length>0&&(o=u.default.extend({},n.interactionOptions,!0)),t&&t.interactionData&&Object.keys(t.interactionData).length>0&&(t.interactionData.routing&&t.interactionData.routing.targetType&&"queue"===t.interactionData.routing.targetType&&(t.interactionData.routing.targetType="Workgroup"),o=l.default.mapProperties(n.oMapping,t,o));var a={pureConnectData:{participantName:g.getDisplayName(s),transcriptEmailAddress:s.email,targetName:o.routingTarget.AltocloudTargetQueue||o.routingTarget.targetName,targetType:o.routingTarget.targetType,language:CXBus.data("App.language"),notes:s.subject,reverseProxyUrl:n.sReverseProxyUrl,caasUrl:n.sCaasUrl,useCaaS:n.bUseCaaS,useHttps:n.bUseHttps,useWebhook:!0},botData:{chatbots:n.chatBotData}};(n.chatbotCustomData||o.botDataCustomInfo)&&(a.botData.customInfo=u.default.extend({},n.chatbotCustomData||{},o.botDataCustomInfo||{},!0)),o.botName&&(a.pureConnectData.botName=o.botName),(o.additionalAttrs||t.interactionData&&t.interactionData.additionalAttrs||t.userData)&&(a.pureConnectData.additionalAttributes=u.default.extend({},o.additionalAttrs||{},t.interactionData&&t.interactionData.additionalAttrs||{},t.userData||{},!0)),o.notes&&(a.pureConnectData.notes?a.pureConnectData.notes=a.pureConnectData.notes.concat("\n"+o.notes):a.pureConnectData.notes=o.notes),o.routingContexts&&(a.pureConnectData.routingContexts=o.routingContexts);var r={type:"POST",endpoint:"/api/v1/start/{server}",data:JSON.stringify(a),retryOnFailure:!0};return g.sendRequest(r).then(function(t){t.sessionId?(n.bOpeningSocket=!0,n.bSessionActive=!0,n.oSessionData.sessionId=t.sessionId,n.oSessionData.displayName=a.pureConnectData.participantName,n.oParticipants["00000000-0000-0000-0000-000000000000"]={name:"System",type:"External"},g.startWebSocketConnection(t).done(function(){e.resolve(t),n.bOpeningSocket=!1})):(n.onError(t),e.reject(t))},function(t){g.handleError(t),e.reject(t)}),e.promise()}},{key:"startPoll",value:function(){this.bPolling=!0,this.poll(),this.onPollingStarted()}},{key:"stopPoll",value:function(){var t=u.default.Deferred();return this.fPollTimeout?(this.bPolling&&(this.bPolling=!1,clearTimeout(this.fPollTimeout),this.fPollTimeout=!1,this.bPollError=!1,this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,this.onPollingStopped(),t.resolve()),t.promise()):(t.reject("Not currently polling. Ignoring command."),t.promise())}},{key:"sendMessage",value:function(t){var e=u.default.Deferred(),n=this,o=n.oSessionData.sessionId;if(n.bSessionActive){var s={message:t.message,contentType:"text/plain"};g.clientStoppedTyping();var a={type:"POST",endpoint:"/api/v1/send-message/{server}/"+o,data:JSON.stringify(s)};g.sendRequest(a).done(function(t){e.resolve()}).fail(function(t){g.handleError(t),e.reject()})}else e.reject("There is no active chat session");return e.promise()}},{key:"sendFile",value:function(){return u.default.Deferred().reject("This transport doesn't support sending files.").promise()}},{key:"sendTyping",value:function(t){var e=u.default.Deferred(),n=this,o=t.type,s="TypingStarted"===o,a=n.oSessionData.sessionId;if(this.bSessionActive){var r={endpoint:"/api/v1/activity/{server}/"+a,type:"POST",data:JSON.stringify({typingIndicator:s})};g.sendRequest(r).done(function(t){e.resolve(t),n.bLastTypingStateSent=s}).fail(function(t){g.handleError(t),e.reject(t)})}else e.reject("There is no active chat session.");return e.promise()}},{key:"asyncRestore",value:function(){var t=u.default.Deferred();return l.default.getCookie(this.sCookie_Session)&&this.restore().done(function(){t.resolve()}),t.promise()}},{key:"restore",value:function(){g.getSessionFromCookie();var t=u.default.Deferred(),e=this,n=this.bSwitchoverDetected,o=e.oSessionData,s=o.sessionId,a=o.participantId;if(this.bRestoring)return u.default.Deferred().reject("Already restoring. Ignoring request.").promise();if(this.bSessionActive)return u.default.Deferred().reject("Chat session is already active, ignoring restore command.").promise();if(e.bRestoring=!0,s&&a){var r={chatId:s,participantId:a},i={endpoint:"/api/v1/restore/{server}/"+s,type:"POST",data:JSON.stringify(r)};g.sendRequest(i).done(function(){e.oParticipants["00000000-0000-0000-0000-000000000000"]={name:"System",type:"External"},g.restore(n).done(function(){e.bRestoring=!1,t.resolve()})}).fail(function(n){e.onError(n),e.onRestoreFailed(n),t.reject(n)})}return t.promise()}},{key:"endChat",value:function(){var t=u.default.Deferred(),e=this.oSessionData.sessionId,n=this;if(!this.bSessionActive)return t.reject("There is no active chat session"),n.onChatEnded(),g.terminateChatSession(),t.promise();var o={type:"POST",endpoint:"/api/v1/end/{server}/"+e};return g.sendRequest(o).done(function(e){n.onChatEnded(),t.resolve(e)}).fail(function(e){e?n.onError({code:e.status||"",message:e.responseText&&e.responseText.message?e.responseText.message:""}):n.onError(),t.reject(e)}).always(function(){g.terminateChatSession()}),t.promise()}},{key:"fetchSessionData",value:function(){return this.oSessionData}},{key:"getAgents",value:function(){return this.oAgents}},{key:"getFileLimits",value:function(){return u.default.Deferred().reject("This transport doesn't support getFileLimits command.").promise()}},{key:"downloadFile",value:function(){return u.default.Deferred().reject("This transport doesn't support file download.").promise()}},{key:"sendCustomNotice",value:function(){return u.default.Deferred().reject("This transport doesn't support sendCustomNotice command.").promise()}},{key:"resetPollExceptions",value:function(){return u.default.Deferred().reject("This transport doesn't support any poll Exceptions.").promise()}}]),t}();CXBus.registerModule("pure-connect-v4-bots-transport",f)}},["./webapp/plugins/cx-webchat-service/transports/pure-connect-v4-bots-transport.js"]);
/*!
 * widgets
 * @version: 9.0.017.30
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([20],{"./webapp/plugins/cx-webchat-service/transports/pure-connect-v4-rest-transport.js":function(t,e,n){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){var n={};for(var s in t)e.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=t[s]);return n}var r=function(){function t(t,e){for(var n=0;n<e.length;n++){var s=e[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,n,s){return n&&t(e.prototype,n),s&&t(e,s),e}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},c=n("./node_modules/jquery/dist/jquery.js"),u=s(c),l=n("./webapp/plugins/cx-common/cx-common.js"),d=s(l),g={init:function(t){g.transport=t},updateSessionCookies:function(){var t=g.transport,e=t.oSessionData;d.default.setCookie(t.sCookie_Session,e.sessionId),d.default.setCookie(t.sCookie_ParticipantId,e.participantId)},removeCookies:function(){var t=g.transport;d.default.deleteCookie(t.sCookie_Session),d.default.deleteCookie(t.sCookie_ParticipantId),d.default.deleteCookie(t.sCookie_Open)},getSessionFromCookie:function(){var t=g.transport;t.oSessionData.sessionId=d.default.getCookie(t.sCookie_Session),t.oSessionData.participantId=d.default.getCookie(t.sCookie_ParticipantId)},transformMessage:function(t){var e=g.transport,n=t.participantId,s=t.sequenceNumber;if(n){var i=e.oParticipants[n];if(i){var o=i.name,r=i.type;t.from={name:o||"",type:r||"Client",id:n}}}return s&&(t.index=s),t},parseMessageForEvents:function(t,e){var n=g.transport,s=n.messageTypeMapping[t.__type],i=t.participantId,o={};if("ParticipantStateChanged"===s){var r=t.state,a=t.participantType;if("WebUser"===a&&(a="Client"),2===r)switch(t.type="participantjoined",n.oParticipants[i]={name:t.displayName,type:a},"Agent"===a&&(n.oAgents[i]={name:t.displayName,connected:!0,supervisor:!1,connectedTime:t.timestamp,disconnectedTime:!1}),t=g.transformMessage(t),o={message:t,agents:n.oAgents},a){case"Agent":n.onAgentConnected(o);break;case"Client":n.onClientConnected(o)}else if(4===r)switch(t.type="participantleft",n.oAgents[i]&&(n.oAgents[i].connected=!1,n.oAgents[i].disconnectedTime=t.timestamp),t=g.transformMessage(t),o={message:t,agents:n.oAgents},a){case"Agent":n.onAgentDisconnected(o),n.onAgentTypingStopped(o);break;case"Client":n.onClientDisconnected(o),n.endChat()}}var p=n.oParticipants[i].type;t=g.transformMessage(t),"Message"!==s||"Agent"!==p&&"Supervisor"!==p||(t.type="message",n.onAgentTypingStopped(t)),"TypingIndicator"===s&&(t.value?(t.type="typingstarted",n.onAgentTypingStarted(t)):(t.type="typingstopped",n.onAgentTypingStopped(t)))},formatMessage:function(t,e){var n=g.transport,s=new Date(t.timestamp).getTime(),i={};return g.parseMessageForEvents(t,e),i.type=t.type?t.type:n.messageTypeMapping[t.__type],"message"===i.type.toLowerCase()&&(i.text=t.value),i.restoring=n.bRestoring,i.index=t.sequenceNumber,i.timestamp=s,i.from={participantId:t.participantId,name:n.oParticipants[t.participantId]&&n.oParticipants[t.participantId].name,type:n.oParticipants[t.participantId]&&n.oParticipants[t.participantId].type},i},parseTranscript:function(t,e){var n=g.transport,s=[];t.forEach(function(t){s.push(g.formatMessage(t,e))}),s.sort(function(t,e){return t.index-e.index}),s.length>0&&n.onMessageReceived({data:{originalMessages:t,messages:s,restoring:!!n.bRestoring,oldMessages:!1}})},refresh:function(t){if(t){var e=t,n=g.transport;!0===e.chatEnded&&!0===n.bSessionActive&&g.terminateChatSession(),e.messages&&e.messages.length&&g.parseTranscript(e.messages)}},restore:function(t){var e=u.default.Deferred(),n=g.transport;return n.bSessionActive=!0,n.onRestore(),t?(n.bRestoring=!1,e.resolve()):g.getAllMessages().then(function(t){t.length&&g.parseTranscript(t,{type:"restore"}),n.bRestoring=!1,n.startPoll(),e.resolve()}),e.promise()},getFormData:function(t){if(t){var e=t.firstname,n=t.lastname,s=o(t,["firstname","lastname"]),i=p({},g.transport.oUserData);return"object"===a(t.userData)&&(i=p({},i,t.userData)),p({firstName:e,lastName:n},i,s)}return{}},terminateChatSession:function(){var t=g.transport;t.stopPoll(),g.removeCookies(),t.bSessionActive=!1,t.oAgents={},t.oSessionData={},t.oParticipants={}},sendRequest:function(t){var e=u.default.Deferred(),n=g.transport,s=t.endpoint,i=o(t,["endpoint"]),r=n.sHost||g.getHost();if(!r)return n.oLastError?e.reject(n.oLastError):e.reject("No more hosts to try.");var a=g.createUrl(r,s);return d.default.request(p({url:a},n.oCommonRequestOptions,i,{success:function(t){n.sHost=r,n.aAttemptedHosts.length=0,t&&t.pollWaitSuggestion&&g.updatePollingInterval(parseInt(t.pollWaitSuggestion)),n.bSwitchoverDetected&&(n.restore(),n.bSwitchoverDetected=!1),e.resolve(t)},error:function(s){n.oLastError=s,503===s.status?(n.sHost&&(n.bSwitchoverDetected=!0,n.bSessionActive=!1),n.sHost="",n.aAttemptedHosts.push(r),s.responseJSON&&s.responseJSON.alternateHostList&&(n.aAdditionalHosts=s.responseJSON.alternateHostList.slice()),g.retry(t,e)):t.retryOnFailure?(n.aAttemptedHosts.push(r),g.retry(t,e)):e.reject(s)}})),e.promise()},retry:function(t,e){g.sendRequest(t).then(function(t){e.resolve(t)},function(t){e.reject(t)})},getHost:function(){var t=g.transport,e=[];return t.aAdditionalHosts.forEach(function(n){t.aAttemptedHosts.includes(n.toLowerCase())||e.push(n.toLowerCase())}),t.aHosts.forEach(function(n){t.aAttemptedHosts.includes(n.toLowerCase())||e.includes(n.toLowerCase())||e.push(n.toLowerCase())}),e.length?e[0]:""},getFileContents:function(t){},handleError:function(t){var e=g.transport,n=t&&(t.responseJSON||t.responseText&&JSON.parse(t.responseText)||{});if(n)var s=n.status;e.onError({code:s&&e.errorPrefix+s||"",response:t})},disconnected:function(){var t=g.transport;t.bDisconnected=!0,t.onDisconnected()},reconnected:function(){var t=g.transport;t.bDisconnected=!1,t.onReconnected()},createUrl:function(t,e){var n=g.transport;return n.sReverseProxyUrl?n.sReverseProxyUrl+"/"+t+e:n.bUseHttps?"https://"+t+":8019"+e:"http://"+t+":8018"+e},getDisplayName:function(t){var e="Customer";return t.nickname?e=t.nickname:t.firstName&&t.lastName&&"string"==typeof t.firstName&&"string"==typeof t.lastName?e=t.firstName+" "+t.lastName:t.firstName&&"string"==typeof t.firstName&&(e=t.firstName),e},updatePollingInterval:function(t){var e=g.transport;e.iPollTimeout_ms=t||1e3,e.iPollTimeout_ms<100&&(e.iPollTimeout_ms=100),e.iIncrementalPollTimeout_ms=e.iPollTimeout_ms},clientStoppedTyping:function(){g.transport.sendTyping({isTyping:!1})},getAllMessages:function(){var t=u.default.Deferred(),e=g.transport,n=e.oSessionData.participantId,s={type:"GET",endpoint:"/icws/web-chat/message-history/"+n};return g.sendRequest(s).then(function(n){var s=n.messages.filter(function(t){return"TypingIndicator"!==e.messageTypeMapping[t.__type]});t.resolve(s)},function(e){t.reject(e),g.handleError(e)}),t.promise()}},f=function(){function t(e){i(this,t),this.oConfig=e,this.bDisconnected=!1;var n="."+e.transport.type;if(this.transportType="",this.oUserData=e.oUserData,this.errorPrefix=e.transport.type+"-",this.oParticipants={},this.oAgents={},this.aHosts=[],this.aAttemptedHosts=[],this.aAdditionalHosts=[],this.sHost,this.bUseHttps=!0,this.sReverseProxyUrl="",this.bSwitchoverDetected=!1,this.oLastError={},this.iClientTypingTimeout=3e3,this.bLastTypingStateSent=!1,this.bSessionActive=!1,this.oSessionData={sessionId:"",participantId:""},this.sCookie_Session=e.sCookie_Prefix+n+".session",this.sCookie_ParticipantId=e.sCookie_Prefix+n+".participantId",this.sCookie_Open=e.sCookie_Prefix+n+".open",this.bPolling=!1,this.bPollingPending=!1,this.bPollError=!1,this.bRestoring=!1,this.oCommonRequestOptions={timeout:e.iAjaxTimeout||3e3,crossDomain:!0,dataType:"json",contentType:"application/json"},this.interactionOptions={routingTarget:{targetType:"",targetName:""},memberInfo:{displayName:"Customer",customFields:{}}},this.oMapping={"interactionData.routing.targetType":{target:"routingTarget.targetType",type:"string",default:"Workgroup"},"interactionData.routing.targetName":{target:"routingTarget.targetName",type:"string"},"interactionData.notes":{target:"notes",type:"string"},"interactionData.routingContexts":{target:"routingContexts"},"interactionData.journey.customerId":{target:"additionalAttrs.AltocloudCustomerId",type:"string"},"interactionData.journey.customerIdType":{target:"additionalAttrs.AltocloudCustomerIdType",type:"string"},"interactionData.journey.actionMapId":{target:"additionalAttrs.AltocloudActionMapId",type:"string"},"userData._actVisitId":{target:"additionalAttrs.AltocloudVisitId",type:"string"},"userData.targetQueue":{target:"routingTarget.AltocloudTargetQueue",type:"string"}},this.messageTypeMapping={"urn:inin.com:webChat:chatTextMessage":"Message","urn:inin.com:webChat:chatFileMessage":"File","urn:inin.com:webChat:chatParticipantStateChangedMessage":"ParticipantStateChanged","urn:inin.com:webChat:chatTypingIndicatorMessage":"TypingIndicator"},"object"===a(e.transport)){var s=e.transport;"string"==typeof s.type&&(this.transportType=s.type),Array.isArray(s.hosts)&&(this.aHosts=s.hosts),"boolean"==typeof s.useHttps&&(this.bUseHttps=s.useHttps),"string"==typeof s.reverseProxyUrl&&(this.sReverseProxyUrl=s.reverseProxyUrl),this.interactionOptions=d.default.mapProperties(this.oMapping,s,this.interactionOptions),this.interactionOptions.additionalAttrs=u.default.extend({},this.interactionOptions.additionalAttrs,s.interactionData.additionalAttrs,!0)}this.onChatStarted=this.onChatStarted.bind(this),this.onMessageReceived=this.onMessageReceived.bind(this),this.onPollingStarted=this.onPollingStarted.bind(this),this.onRestore=this.onRestore.bind(this),this.onError=this.onError.bind(this),g.init(this)}return r(t,[{key:"onCapabilitiesChanged",value:function(t){}},{key:"onChatEnded",value:function(t){}},{key:"onChatStarted",value:function(t,e){}},{key:"onError",value:function(t){}},{key:"onMessageReceived",value:function(t){}},{key:"onPollingStarted",value:function(){}},{key:"onRestore",value:function(t){}},{key:"onRestoreFailed",value:function(t){}},{key:"onTypingStarted",value:function(){}},{key:"onTypingStopped",value:function(){}},{key:"startChat",value:function(t){var e=u.default.Deferred(),n=this,s="",i=g.getFormData(t.form);n.interactionOptions&&Object.keys(n.interactionOptions).length>0&&(s=n.interactionOptions),t&&t.interactionData&&Object.keys(t.interactionData).length>0&&(t.interactionData.routing&&t.interactionData.routing.targetType&&"queue"===t.interactionData.routing.targetType&&(t.interactionData.routing.targetType="Workgroup"),s=d.default.mapProperties(n.oMapping,t,s));var o={participantName:g.getDisplayName(i),transcriptEmailAddress:i.email,targetName:s.routingTarget.AltocloudTargetQueue||s.routingTarget.targetName,targetType:s.routingTarget.targetType,language:CXBus.data("App.language"),notes:i.subject};(s.additionalAttrs||t.interactionData&&t.interactionData.additionalAttrs||t.userData)&&(o.additionalAttributes=u.default.extend({},s.additionalAttrs||{},t.interactionData&&t.interactionData.additionalAttrs||{},t.userData||{},!0)),s.notes&&(o.notes?o.notes=o.notes.concat("\n"+s.notes):o.notes=s.notes),s.routingContexts&&(o.routingContexts=s.routingContexts);var r={type:"POST",endpoint:"/icws/web-chat/start",data:JSON.stringify(o),retryOnFailure:!0};return g.sendRequest(r).then(function(t){t.chatId?(n.bSessionActive=!0,n.oSessionData.sessionId=t.chatId,n.oSessionData.participantId=t.participantId,n.oSessionData.displayName=o.participantName,n.oParticipants["00000000-0000-0000-0000-000000000000"]={name:"System",type:"External"},g.updateSessionCookies(),n.onChatStarted({data:n.oSessionData},t),n.startPoll(),e.resolve(t)):(e.reject(t),n.onError(t))},function(t){e.reject(t),g.handleError(t)}),e.promise()}},{key:"startPoll",value:function(){this.bPolling=!0,this.poll(),this.onPollingStarted()}},{key:"stopPoll",value:function(){var t=u.default.Deferred();return this.fPollTimeout?(this.bPolling&&(this.bPolling=!1,clearTimeout(this.fPollTimeout),this.fPollTimeout=!1,this.bPollError=!1,this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,this.onPollingStopped(),t.resolve()),t.promise()):(t.reject("Not currently polling. Ignoring command."),t.promise())}},{key:"_longPoll",value:function(){var t=this;this.bPolling&&(this.bPollError?this.iIncrementalPollTimeout_ms=this.iIncrementalPollTimeout_ms+1e3:this.iIncrementalPollTimeout_ms=this.iPollTimeout_ms,this.fPollTimeout=setTimeout(function(){t.poll()},this.iIncrementalPollTimeout_ms))}},{key:"poll",value:function(){var t=this,e=u.default.Deferred(),n=this.oSessionData,s=n.sessionId,i=n.participantId;if(!t.bSessionActive)return e.reject("There is no active chat session"),!1;if(s&&!this.bPollingPending){this.bPollingPending=!0;var o={type:"GET",endpoint:"/icws/web-chat/messages/"+i};g.sendRequest(o).then(function(n){t.bPollError=!1,t.bPollingPending=!1,g.refresh(n),t._longPoll(),t.bDisconnected&&g.reconnected(),e.resolve()},function(t){g.handleError(t)})}else e.reject();return e.promise()}},{key:"sendMessage",value:function(t){var e=u.default.Deferred(),n=this,s=n.oSessionData.participantId;if(n.bSessionActive){var i={message:t.message,type:"text/plain"};g.clientStoppedTyping();var o={type:"POST",endpoint:"/icws/web-chat/send-message/"+s,data:JSON.stringify(i)};g.sendRequest(o).done(function(t){e.resolve()}).fail(function(t){g.handleError(t),e.reject()})}else e.reject("There is no active chat session");return e.promise()}},{key:"sendFile",value:function(){return u.default.Deferred().reject("This transport doesn't support sending files.").promise()}},{key:"sendTyping",value:function(t){var e=u.default.Deferred(),n=this,s=t.type,i="TypingStarted"===s,o=n.oSessionData.participantId;if(this.bSessionActive){var r={endpoint:"/icws/web-chat/typing-state/"+o,type:"POST",data:JSON.stringify({typingIndicator:i})};g.sendRequest(r).done(function(t){e.resolve(t),n.bLastTypingStateSent=i}).fail(function(t){g.handleError(t),e.reject(t)})}else e.reject("There is no active chat session.");return e.promise()}},{key:"asyncRestore",value:function(){var t=u.default.Deferred();return d.default.getCookie(this.sCookie_Session)&&this.restore().done(function(){t.resolve()}),t.promise()}},{key:"restore",value:function(){g.getSessionFromCookie();var t=u.default.Deferred(),e=this,n=this.bSwitchoverDetected,s=e.oSessionData,i=s.sessionId,o=s.participantId;if(this.bRestoring)return u.default.Deferred().reject("Already restoring. Ignoring request.").promise();if(this.bSessionActive)return u.default.Deferred().reject("Chat session is already active, ignoring restore command.").promise();if(e.bRestoring=!0,i&&o){var r={chatId:i,participantId:o},a={endpoint:"/icws/web-chat/reconnect",type:"POST",data:JSON.stringify(r)};g.sendRequest(a).done(function(){e.oParticipants["00000000-0000-0000-0000-000000000000"]={name:"System",type:"External"},g.restore(n).done(function(){e.bRestoring=!1,t.resolve()})}).fail(function(n){e.onError(n),e.onRestoreFailed(n),t.reject(n)})}return t.promise()}},{key:"endChat",value:function(){var t=u.default.Deferred(),e=this.oSessionData.participantId,n=this;if(!this.bSessionActive)return t.reject("There is no active chat session"),n.onChatEnded(),g.terminateChatSession(),t.promise();this.stopPoll();var s={type:"POST",endpoint:"/icws/web-chat/exit/"+e};return g.sendRequest(s).done(function(e){n.onChatEnded(),t.resolve(e)}).fail(function(e){e?n.onError({code:e.status||"",message:e.responseText&&e.responseText.message?e.responseText.message:""}):n.onError(),t.reject(e)}).always(function(){g.terminateChatSession()}),t.promise()}},{key:"fetchSessionData",value:function(){return this.oSessionData}},{key:"getAgents",value:function(){return this.oAgents}},{key:"getFileLimits",value:function(){return u.default.Deferred().reject("This transport doesn't support getFileLimits command.").promise()}},{key:"downloadFile",value:function(){return u.default.Deferred().reject("This transport doesn't support file download.").promise()}},{key:"sendCustomNotice",value:function(){return u.default.Deferred().reject("This transport doesn't support sendCustomNotice command.").promise()}},{key:"resetPollExceptions",value:function(){return u.default.Deferred().reject("This transport doesn't support any poll Exceptions.").promise()}}]),t}();CXBus.registerModule("pure-connect-v4-rest-transport",f)}},["./webapp/plugins/cx-webchat-service/transports/pure-connect-v4-rest-transport.js"]);